<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width" />
    <meta charset="utf-8" />
    <title>Sign up or sign in</title>
    <meta name="next-head-count" content="3" />
    <link rel="stylesheet" href="https://use.typekit.net/hjz6hxl.css" />
    <!-- Currently pulling in bootstrap directly and modifying the styles we need.
    Ideally it'd be nice to directly link our stylesheet hosted with the new TPS. -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css"
    />

    <link id="local-stylesheet" rel="stylesheet" href="styles.css" />

    <script>
      // Cd from root in to azure/login and then use serve to view locally
      const localBuildUrl = "http://localhost:5000/";
      // Local gh page.  This is currently being hosted via personal gh page.
      // We will likely end up hosting this in azure soon.
      const ghPagesUrl = "https://nathantrost.github.io/azure-b2c-template/";

      const isLiveAzure = !(
        window.location.href === localBuildUrl ||
        window.location.href === ghPagesUrl
      );

      const envId = (name) => (isLiveAzure ? name : `${name}-dev`);
      const submitButtonId = envId("next");

      let inputValidation = {};

      // Minimum eight and maximum 30 characters,
      // At least 1 special character
      // At least 1 number
      // At least 1 uppercase and 1 lowercase letter
      const passwordCriteriaRegex =
        "^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,30}$";

      const liveValidationErrorDefinitions = {
        email:
          "<strong>Try again</strong>. Please enter a valid email address that includes an @ sign and a domain, like abc@mail.com.",
        password:
          "Your password must be at least eight characters long, and contain at least one special character, one number, one lowercase letter, and one uppercase letter.",
      };

      // Show mock form if in local or gh-pages environments,
      // This is a copy from basic azure form, with all id's appended with '-dev'
      // We instantly remove this node if we're not in development environment
      const handleDevMockContent = () => {
        const apiDevForm = document.getElementById("api-dev");
        if (isLiveAzure) {
          // direct stylesheet to ghpages
          const localStylesheet = document.getElementById("local-stylesheet");
          localStylesheet.setAttribute(
            "href",
            `${ghPagesUrl}/${localStylesheet.getAttribute("href")}`
          );
          // Remove test data
          return apiDevForm.remove();
        } else {
          return (apiDevForm.style.opacity = 1);
        }
      };

      const buildToggleButton = (passwordInput) => {
        const id = `${passwordInput.id}-visibilityToggler`;

        const button = document.createElement("button");
        Object.assign(button, {
          id,
          className: "showPasswordButton btn btn-link input-group-append",
          type: "button",
          textContent: "Show",
        });
        passwordInput.insertAdjacentElement("afterend", button);

        const toggleVisibility = () =>
          (passwordInput.type =
            passwordInput.type === "password" ? "text" : "password");

        button.onclick = toggleVisibility;
        // For non-mouse usage
        button.onkeydown = toggleVisibility;
      };

      const createPasswordToggleButtons = () => {
        const passwordInputs = document.querySelectorAll(
          "input[type=password]"
        );
        passwordInputs.forEach((input) => buildToggleButton(input));
      };

      const validateField = (event) => {
        const { id, pattern, value } = event.target;
        const isValid = new RegExp(pattern).test(value);
        const fieldWrapper = document.getElementById(`inputWrapper-${id}`);

        if (value.length && !isValid) {
          fieldWrapper.classList.add("inputWrapper__invalid");
        } else {
          fieldWrapper.classList.remove("inputWrapper__invalid");
        }
        inputValidation[id] = isValid;
        submitButtonValidation();
      };

      const submitButtonValidation = () => {
        const allInputsAreValid = Object.keys(inputValidation).every(
          (input) => inputValidation[input] === true
        );
        const submitButton = document.getElementById(submitButtonId);
        Object.assign(submitButton, {
          disabled: !allInputsAreValid,
        });
      };

      const wrap = (el, wrapper) => {
        el.parentNode.insertBefore(wrapper, el);
        wrapper.appendChild(el);
      };

      const shapeEntryItems = () => {
        const azureFormWrapper = document.querySelector(".entry");
        azureFormWrapper.classList.add("formWrapper", "shadow-lg");
        // Add unique id and custom classes to 'entry-item'
        const azureWrappers = document.querySelectorAll(".entry-item");
        azureWrappers.forEach((wrapper) => {
          const { id } = wrapper.querySelector("input");
          wrapper.setAttribute("id", `inputWrapper-${id}`);
          wrapper.classList.add("inputWrapper", `inputWrapper__${id}`);
        });
      };

      const shapeFormLabels = () => {
        // Wrap labels & make them uniform
        const azureLabels = document.querySelectorAll(".entry-item label");
        azureLabels.forEach((label) => {
          if (label.parentElement.classList.contains("entry-item")) {
            labelWrapper = document.createElement("div");
            Object.assign(labelWrapper, {
              id: `${label.htmlFor}-label-wrapper`,
              className: `labelWrapper__${label.htmlFor} labelWrapper`,
            });
            wrap(label, labelWrapper);
          } else {
            label.parentElement.classList.add("labelWrapper");
          }
        });
      };

      const shapeInputs = () => {
        // Wrap inputs and use BS 'input-group' & 'form-control' classes
        const azureInputs = document.querySelectorAll(".entry-item input");
        azureInputs.forEach((input) => {
          const inputGroup = document.createElement("div");

          let { pattern } = input;
          if (!pattern) {
            pattern = input.type === "password" ? passwordCriteriaRegex : ".*";
          }

          Object.assign(input, {
            className: "form-control",
            autoComplete: input.type,
            onblur: validateField,
            pattern,
          });
          Object.assign(inputGroup, {
            id: `inputGroup-${input.id}`,
            className: `inputGroup__${input.id} input-group`,
          });
          const errorBlock = document.createElement("div");
          Object.assign(errorBlock, {
            id: `liveValidationBlock-${input.id}`,
            className: "liveValidationBlock",
          });
          errorBlock.innerHTML = liveValidationErrorDefinitions[input.type];

          wrap(input, inputGroup);
          inputGroup.insertAdjacentElement("afterend", errorBlock);

          // Add each input to inputValidation object so we can keep track of
          // what's valid and what isn't
          inputValidation[input.id] = false;
        });
      };

      const shapeNonInputElements = () => {
        const azureSignInMessage = document.querySelector(".intro h2");
        const newSignInMessage = document.createElement("h1");
        Object.assign(newSignInMessage, {
          id: "signInMessage",
          className: "signInMessage",
          textContent: "Sign in to your account",
        });

        azureSignInMessage.parentNode.replaceChild(
          newSignInMessage,
          azureSignInMessage
        );

        // Copy "create account" node and move it below "Sign in" text
        const azureCreate = document.querySelector(".create");
        const copiedCreate = azureCreate.cloneNode(true);
        const azureIntro = document.querySelector(".intro");
        azureIntro.insertAdjacentElement("afterend", copiedCreate);
        azureCreate.remove();

        const createAccountId = envId("createAccount");
        const azureCreateLink = document.getElementById(createAccountId);
        Object.assign(azureCreateLink, {
          className: "createAccountLink btn btn-link",
          textContent: "Create",
        });

        const forgotPasswordId = envId("forgotPassword");
        const azureForgotPassword = document.getElementById(forgotPasswordId);
        azureForgotPassword.setAttribute(
          "class",
          "forgotPasswordLink btn btn-link"
        );

        // Remove "or" divider, we could also just hide this.
        const azureDivider = document.querySelector(".divider");
        azureDivider.remove();
      };

      const shapeSubmitButton = () => {
        const azureButtonWrapper = document.querySelector(".buttons");
        azureButtonWrapper.classList.add("submitButtonWrapper");
        const submitButton = document.getElementById(submitButtonId);
        Object.assign(submitButton, {
          className: "btn btn-primary",
          disabled: true,
        });
      };

      // Copied from https://gist.github.com/jwilson8767/db379026efcbd932f64382db4b02853e
      const elementReady = (selector) => {
        return new Promise((resolve, reject) => {
          let el = document.querySelector(selector);
          if (el) {
            resolve(el);
          }
          new MutationObserver((mutationRecords, observer) => {
            // Query for elements matching the specified selector
            Array.from(document.querySelectorAll(selector)).forEach(
              (element) => {
                resolve(element);
                //Once we have resolved we don't need the observer anymore.
                observer.disconnect();
              }
            );
          }).observe(document.documentElement, {
            childList: true,
            subtree: true,
          });
        });
      };

      setTimeout(() => {
        handleDevMockContent();
        elementReady("#api").then(() => {
          shapeEntryItems();
          shapeFormLabels();
          shapeInputs();
          shapeSubmitButton();
          shapeNonInputElements();
          createPasswordToggleButtons();
          // Make smooth CSS transition for api form elements
          const azureForm = document.getElementById("api");
          azureForm.style.opacity = 1;
        });
      }, 500);
    </script>
  </head>

  <body>
    <div class="container">
      <!-- 'api-dev' is a copy of the markup provided by azure.  
        The point of including this here is to aid in local development.
        If this is viewed locally ('http://localhost:5000/') via 'serve', or
        in github pages (currently 'https://nathantrost.github.io/azure-b2c-template/')
        'api-dev' will be visible as a non-functional form.  Otherwise, 'api-dev'
        will be removed.
       -->
      <div id="api-dev" style="opacity: 0">
        <form
          id="localAccountForm-dev"
          action="JavaScript:void(0);"
          class="localAccount"
          aria-label="Sign in with your email address"
        >
          <div class="intro">
            <h2 aria-level="1">Sign in with your email address</h2>
          </div>
          <div
            class="error pageLevel"
            aria-hidden="true"
            role="alert"
            style="display: none"
          >
            <p></p>
          </div>
          <div class="entry">
            <div class="entry-item">
              <label for="email"> Email Address </label>
              <div
                class="error itemLevel"
                aria-hidden="true"
                role="alert"
                style="display: none"
              >
                <p></p>
              </div>
              <input
                autocomplete="email"
                type="email"
                id="email-dev"
                name="Email Address"
                title="Please enter a valid Email Address"
                pattern="^[a-zA-Z0-9!#$%&amp;'+^_`{}~-]+(?:\.[a-zA-Z0-9!#$%&amp;'+^_`{}~-]+)*@(?:[a-zA-Z0-9](?:[a-zA-Z0-9-]*[a-zA-Z0-9])?\.)+[a-zA-Z0-9](?:[a-zA-Z0-9-]*[a-zA-Z0-9])?$"
                autofocus=""
                placeholder="Email Address"
                aria-label="Email Address"
              />
            </div>
            <div class="entry-item">
              <div class="password-label">
                <label for="password">Password</label>
                <a
                  id="forgotPassword-dev"
                  href="/amub2c.onmicrosoft.com/B2C_1_test2/api/CombinedSigninAndSignup/unified?claimsexchange=ForgotPassword&amp;csrf_token=mockToken4LocalDevelopment&amp;p=B2C_1_test2"
                  >Forgot your password?</a
                >
              </div>
              <div
                class="error itemLevel"
                aria-hidden="true"
                style="display: none"
              >
                <p role="alert"></p>
              </div>
              <input
                autocomplete="current-password"
                type="password"
                id="password-dev"
                name="Password"
                placeholder="Password"
                aria-label="Password"
                autocomplete="current-password"
                aria-required="true"
                pattern="^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,30}$"
              />
            </div>
            <div class="working"></div>

            <div class="buttons">
              <button id="next-dev" type="submit" form="localAccountForm">
                Sign in
              </button>
            </div>
          </div>
          <div class="divider">
            <h2>OR</h2>
          </div>
          <div class="create">
            <p>
              Don't have an account?<a
                id="createAccount-dev"
                href="/amub2c.onmicrosoft.com/B2C_1_test2/api/CombinedSigninAndSignup/unified?local=signup&amp;csrf_token=mockToken4LocalDevelopment&amp;p=B2C_1_test2"
                >Sign up now</a
              >
            </p>
          </div>
        </form>
      </div>

      <div id="api" style="opacity: 0"></div>
    </div>
  </body>
</html>
