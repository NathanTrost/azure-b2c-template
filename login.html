<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width" />
    <meta charset="utf-8" />
    <title>Sign up or sign in</title>
    <meta name="next-head-count" content="3" />
    <link rel="stylesheet" href="https://use.typekit.net/hjz6hxl.css" />
    <!-- Currently pulling in bootstrap directly and modifying the styles we need.
    Ideally it'd be nice to directly link our stylesheet hosted with the new TPS. -->

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css"
    />
    <script>
      const envUrls = {
        // Cd from root in to azure and then use serve to view locally.
        // This file would be found at localhost:5000/login.
        local: "http://localhost:5000/",
        // You can find these files in the general AMU Azure directory in the
        // puzzlesocietylogin Storage account.
        azureTemplate: "https://puzzlesocietylogin.z13.web.core.windows.net/",
        azureLogin: "https://amub2c.b2clogin.com",
      };

      const isLiveAzure = window.location.href.startsWith(envUrls.azureLogin);
      const baseUrl = isLiveAzure ? envUrls.azureTemplate : envUrls.local;

      const envId = (name) => (isLiveAzure ? name : `${name}-dev`);

      // Show mock form if developing locally or outside of azure.
      // This is a copy from basic azure form, with all id's appended with '-dev'
      // We instantly remove 'api-dev' node if we're not in development environment
      // otherwise remove the 'api' node
      const handleDevMockContent = () =>
        document.getElementById(isLiveAzure ? "api-dev" : "api").remove();

      const loadStylesheet = () => {
        const stylesheet = document.createElement("link");

        Object.assign(stylesheet, {
          id: "local-stylesheet",
          href: baseUrl + "styles.css",
          rel: "stylesheet",
          type: "text/css",
        });
        document.getElementsByTagName("head")[0].appendChild(stylesheet);
      };

      // Unable to use relative paths in azure, should we want to centrallize js,
      // we could use something along these lines to do it.
      // const scriptAssets = ['utils.js'];
      // const loadScriptAssets = () => {
      //   scriptAssets.forEach((asset) => {
      //     const scriptTag = document.createElement('script');
      //     const base = isLiveAzure ? baseUrl.azure : baseUrl.local;
      //     document.src = baseUrl + asset;
      //     document.getElementsByTagName('head')[0].appendChild(scriptTag);
      //   });
      // };
    </script>
    <script>
      const submitButtonId = envId("next");

      let inputValidation = {};

      // Minimum eight and maximum 30 characters,
      // At least 1 special character
      // At least 1 number
      // At least 1 uppercase and 1 lowercase letter
      const passwordCriteriaRegex =
        "^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[!@#$%^&*?_=+-]).{8,30}$";

      const liveValidationErrorDefinitions = {
        email:
          "<strong>Try again</strong>. Please enter a valid email address that includes an @ sign and a domain, like abc@mail.com.",
        password:
          "Your password must be at least eight characters long, and contain at least one special character, one number, one lowercase letter, and one uppercase letter.",
      };

      const buildToggleButton = (passwordInput) => {
        const id = `${passwordInput.id}-visibilityToggler`;

        const button = document.createElement("button");
        Object.assign(button, {
          id,
          className: "showPasswordButton btn btn-link input-group-append",
          type: "button",
          textContent: "Show",
        });
        passwordInput.insertAdjacentElement("afterend", button);

        const toggleVisibility = () =>
          (passwordInput.type =
            passwordInput.type === "password" ? "text" : "password");

        button.onclick = toggleVisibility;
        // For non-mouse usage
        button.onkeydown = toggleVisibility;
      };

      const createPasswordToggleButtons = () => {
        const passwordInputs = document.querySelectorAll(
          "input[type=password]"
        );
        passwordInputs.forEach((input) => buildToggleButton(input));
      };

      const validateField = (event) => {
        const { id, pattern, value } = event.target;
        const isValid = new RegExp(pattern).test(value);
        const fieldWrapper = document.getElementById(`${id}-inputWrapper`);

        const validClass = "inputWrapper--valid";
        const invalidClass = "inputWrapper--invalid";

        if (value.length) {
          if (!isValid) {
            fieldWrapper.classList.remove(validClass);
            fieldWrapper.classList.add(invalidClass);
          } else {
            fieldWrapper.classList.remove(invalidClass);
            fieldWrapper.classList.add(validClass);
          }
        } else {
          fieldWrapper.classList.remove(invalidClass, validClass);
        }
        inputValidation[id] = isValid;
        submitButtonValidation();
      };

      const submitButtonValidation = () => {
        const allInputsAreValid = Object.keys(inputValidation).every(
          (input) => inputValidation[input] === true
        );
        const submitButton = document.getElementById(submitButtonId);
        Object.assign(submitButton, {
          disabled: !allInputsAreValid,
        });
      };

      const shapeEntryItems = ({ formWrapperNode, inputWrapperNode }) => {
        const azureFormWrapper = document.querySelector(formWrapperNode);
        azureFormWrapper.setAttribute("id", "formWrapper");
        azureFormWrapper.classList.add("formWrapper", "shadow-lg");

        // Add unique id and custom classes to 'entry-item'
        const azureWrappers = document.querySelectorAll(inputWrapperNode);
        azureWrappers.forEach((wrapper) => {
          const input = wrapper.querySelector("input");
          if (input) {
            const { id } = input;
            wrapper.setAttribute("id", `${id}-inputWrapper`);
            wrapper.classList.add("inputWrapper", `inputWrapper--${id}`);
          }
        });
      };

      const shapeFormLabels = ({ inputWrapperNode }) => {
        // Wrap labels & make them uniform
        const azureLabels = document.querySelectorAll(
          `${inputWrapperNode} label`
        );
        azureLabels.forEach((label) => {
          if (
            label.parentElement.classList.contains(
              inputWrapperNode.replace(".", "")
            )
          ) {
            labelWrapper = document.createElement("div");
            Object.assign(labelWrapper, {
              id: `${label.htmlfor}-labelWrapper`,
              className: `labelWrapper labelWrapper--${label.htmlFor}`,
            });
            wrap(label, labelWrapper);
          } else {
            label.parentElement.classList.add("labelWrapper");
          }
        });
      };

      const shapeInputs = ({ inputNode }) => {
        // Wrap inputs and use BS 'input-group' & 'form-control' classes
        const azureInputs = document.querySelectorAll(inputNode);
        console.log(azureInputs);
        azureInputs.forEach((input) => {
          const inputGroup = document.createElement("div");

          let { pattern } = input;
          if (!pattern) {
            pattern = input.type === "password" ? passwordCriteriaRegex : ".*";
          }

          Object.assign(input, {
            className: "form-control",
            autoComplete: input.type,
            onblur: validateField,
            pattern,
          });
          Object.assign(inputGroup, {
            id: `${input.id}-inputGroup`,
            className: `inputGroup--${input.id} input-group`,
          });
          const errorBlock = document.createElement("div");
          Object.assign(errorBlock, {
            id: `liveValidationBlock-${input.id}`,
            className: "liveValidationBlock",
          });
          errorBlock.innerHTML = liveValidationErrorDefinitions[input.type];

          wrap(input, inputGroup);
          inputGroup.insertAdjacentElement("afterend", errorBlock);

          // Add each input to inputValidation object so we can keep track of
          // what's valid and what isn't
          inputValidation[input.id] = false;
        });
      };

      const shapeNonInputElements = () => {
        const azureSignInMessage = document.querySelector(".intro h2");
        const newSignInMessage = document.createElement("h1");
        Object.assign(newSignInMessage, {
          id: "signInMessage",
          className: "signInMessage",
          textContent: "Sign in to your account",
        });

        azureSignInMessage.parentNode.replaceChild(
          newSignInMessage,
          azureSignInMessage
        );

        // Copy "create account" node and move it below "Sign in" text
        const azureCreate = document.querySelector(".create");
        const copiedCreate = azureCreate.cloneNode(true);
        const azureIntro = document.querySelector(".intro");
        azureIntro.insertAdjacentElement("afterend", copiedCreate);
        azureCreate.remove();

        const createAccountId = envId("createAccount");
        const azureCreateLink = document.getElementById(createAccountId);
        Object.assign(azureCreateLink, {
          className:
            "btn btn-link buttonLink--wrappedParens buttonLink--createAccount",
          textContent: "Create",
        });

        const forgotPasswordId = envId("forgotPassword");
        const azureForgotPassword = document.getElementById(forgotPasswordId);
        azureForgotPassword.setAttribute(
          "class",
          "btn btn-link buttonLink--wrappedParens buttonLink--forgotPassword"
        );

        // Remove "or" divider, we could also just hide this.
        const azureDivider = document.querySelector(".divider");
        azureDivider.remove();
      };

      const shapeSubmitButton = () => {
        const azureButtonWrapper = document.querySelector(".buttons");
        azureButtonWrapper.classList.add("submitButtonWrapper");
        const submitButton = document.getElementById(submitButtonId);
        Object.assign(submitButton, {
          className: "btn btn-primary",
          disabled: true,
        });
      };

      // Copied from https://gist.github.com/jwilson8767/db379026efcbd932f64382db4b02853e
      const elementReady = (selector) => {
        return new Promise((resolve, reject) => {
          let el = document.querySelector(selector);
          if (el) {
            resolve(el);
          }
          new MutationObserver((mutationRecords, observer) => {
            // Query for elements matching the specified selector
            Array.from(document.querySelectorAll(selector)).forEach(
              (element) => {
                resolve(element);
                //Once we have resolved we don't need the observer anymore.
                observer.disconnect();
              }
            );
          }).observe(document.documentElement, {
            childList: true,
            subtree: true,
          });
        });
      };

      const wrap = (el, wrapper) => {
        el.parentNode.insertBefore(wrapper, el);
        wrapper.appendChild(el);
      };

      setTimeout(() => {
        const apiId = `#${envId("api")}`;
        handleDevMockContent();
        loadStylesheet();
        // loadScriptAssets();
        elementReady(apiId).then(() => {
          shapeEntryItems({
            formWrapperNode: ".entry",
            inputWrapperNode: ".entry-item",
          });

          shapeFormLabels({ inputWrapperNode: ".entry-item" });

          shapeInputs({ inputNode: ".entry-item input" });
          shapeSubmitButton();
          shapeNonInputElements();
          createPasswordToggleButtons();
          // Make smooth CSS transition for api form elements
          const azureForm = document.getElementById(envId("api"));
          azureForm.style.opacity = 1;
        });
      }, 500);
    </script>
  </head>

  <body>
    <div class="container">
      <div id="api-dev" style="opacity: 0">
        <!-- 'api-dev' is a copy of the markup provided by azure.  
        The point of including this here is to aid in local development.
        If this is viewed locally ('http://localhost:5000/') via 'serve', or
        in github pages (currently 'https://nathantrost.github.io/azure-b2c-template/')
        'api-dev' will be visible as a non-functional form.  Otherwise, 'api-dev'
        will be removed.
       -->
        <form
          id="localAccountForm-dev"
          action="JavaScript:void(0);"
          class="localAccount"
          aria-label="Sign in with your email address"
        >
          <div class="intro">
            <h2 aria-level="1">Sign in with your email address</h2>
          </div>
          <div
            class="error pageLevel"
            aria-hidden="true"
            role="alert"
            style="display: none"
          >
            <p></p>
          </div>
          <div class="entry">
            <div class="entry-item">
              <label for="email"> Email Address </label>
              <div
                class="error itemLevel"
                aria-hidden="true"
                role="alert"
                style="display: none"
              >
                <p></p>
              </div>
              <input
                autocomplete="email"
                type="email"
                id="email-dev"
                name="Email Address"
                title="Please enter a valid Email Address"
                pattern="^[a-zA-Z0-9!#$%&amp;'+^_`{}~-]+(?:\.[a-zA-Z0-9!#$%&amp;'+^_`{}~-]+)*@(?:[a-zA-Z0-9](?:[a-zA-Z0-9-]*[a-zA-Z0-9])?\.)+[a-zA-Z0-9](?:[a-zA-Z0-9-]*[a-zA-Z0-9])?$"
                autofocus=""
                placeholder="Email Address"
                aria-label="Email Address"
              />
            </div>
            <div class="entry-item">
              <div class="password-label">
                <label for="password">Password</label>
                <a
                  id="forgotPassword-dev"
                  href="/amub2c.onmicrosoft.com/B2C_1_test2/api/CombinedSigninAndSignup/unified?claimsexchange=ForgotPassword&amp;csrf_token=mockToken4LocalDevelopment&amp;p=B2C_1_test2"
                  >Forgot your password?</a
                >
              </div>
              <div
                class="error itemLevel"
                aria-hidden="true"
                style="display: none"
              >
                <p role="alert"></p>
              </div>
              <input
                autocomplete="current-password"
                type="password"
                id="password-dev"
                name="Password"
                placeholder="Password"
                aria-label="Password"
                autocomplete="current-password"
                aria-required="true"
              />
            </div>
            <div class="working"></div>

            <div class="buttons">
              <button id="next-dev" type="submit" form="localAccountForm">
                Sign in
              </button>
            </div>
          </div>
          <div class="divider">
            <h2>OR</h2>
          </div>
          <div class="create">
            <p>
              Don't have an account?<a
                id="createAccount-dev"
                href="/amub2c.onmicrosoft.com/B2C_1_test2/api/CombinedSigninAndSignup/unified?local=signup&amp;csrf_token=mockToken4LocalDevelopment&amp;p=B2C_1_test2"
                >Sign up now</a
              >
            </p>
          </div>
        </form>
      </div>

      <div id="api" style="opacity: 0"></div>
    </div>
  </body>
</html>
